{
    "blocks": {
        "start": {
            "actions": [
                {
                    "action": "astersay.actions.SayAction",
                    "config": {
                        "text": "Меня зовут Виктория, я голосовой помощник. Какое лечение или обследование получили в диспансере?"
                    },
                    "name": "first_say",
                    "start_on": ["block_start"],
                    "type": "say"
                }
            ],
            "exit_points": [
                {
                    "block": "service_category",
                    "condition": ["first_say_result", "in", [true, false]]
                }
            ]
        },
        "service_category": {
            "actions": [
                {
                    "action": "astersay.actions.CaptureAction",
                    "type": "capture",
                    "start_on": ["block_start"],
                    "name": "category_say",
                    "config": {
                        "new_buffer": true,
                        "maxsilence": 3,
                        "task_time": 30,
                        "minlength": 2,
                        "mode_buffer": 3
                    }
                },
                {
                    "action": "astersay.actions.SilenceAction",
                    "type": "silence",
                    "start_on": ["block_start"],
                    "name": "category_say_silence",
                    "config": {
                        "task_time": 20,
                        "max_silence": 18,
                        "new_buffer": true,
                        "phrases": ["Я вас не слышу."]
                    }
                }
            ],
            "exit_points": [
                {
                    "condition": ["category_say_result", "=", false],
                    "block": "bad_finish"
                },
                {
                    "condition": ["category_say_result", "=", true],
                    "block": "user_grade"
                }
            ]
        },
        "user_grade": {
            "actions": [
                {
                    "action": "astersay.actions.SayAction",
                    "type": "say",
                    "start_on": ["block_start"],
                    "name": "ug_first_say",
                    "config": {
                        "text": "Оцените нашу работу от 1 до 5"
                    }
                },
                {
                    "action": "astersay.actions.SearchByBufferAction",
                    "type": "search_by_buffer",
                    "start_on": ["block_start"],
                    "name": "quality",
                    "config": {
                        "task_time": 30,
                        "new_buffer": true,
                        "mode_buffer": 3,
                        "pattern": "[1-5]{1}|один|два|три|четыре|пять"
                    }
                },
                {
                    "action": "astersay.actions.SilenceAction",
                    "type": "silence",
                    "start_on": ["ug_first_say__finish"],
                    "name": "quality_silence",
                    "config": {
                        "task_time": 20,
                        "max_silence": 13,
                        "phrases": ["Я вас не слышу."],
                        "phrase_alternate": "Скажите цифру от 1 до 5."
                    }
                },
                {
                    "action": "astersay.actions.ConvertAction",
                    "type": "convert",
                    "start_on": ["quality__finish"],
                    "name": "quality_int",
                    "config": {
                        "variable": "quality_value",
                        "values": {
                            "1": 1,
                            "2": 2,
                            "3": 3,
                            "4": 4,
                            "5": 5,
                            "один": 1,
                            "два": 2,
                            "три": 3,
                            "четыре": 4,
                            "пять": 5
                        }
                    }
                },
                {
                    "action": "astersay.actions.ConvertAction",
                    "type": "convert",
                    "start_on": ["quality__finish"],
                    "name": "quality_str",
                    "config": {
                        "variable": "quality_value",
                        "values": {
                            "1": "1",
                            "2": "2",
                            "3": "3",
                            "4": "4",
                            "5": "5",
                            "один": "1",
                            "два": "2",
                            "три": "3",
                            "четыре": "4",
                            "пять": "5"
                        }
                    }
                }
            ],
            "exit_points": [
                {
                    "condition": ["quality_result", "=", false],
                    "block": "fad_finish"
                },
                {
                    "condition": ["quality_result", "=", true],
                    "block": "capture_question"
                }
            ]
        },
        "capture_question": {
            "actions": [
                {
                    "start_on": ["block_start"],
                    "action": "astersay.actions.SayAction",
                    "config": {
                        "text": "Добавьте комментарий к вашей оценке"
                    },
                    "name": "cq_first_say",
                    "type": "say"
                },
                {
                    "action": "astersay.actions.CaptureAction",
                    "type": "capture",
                    "start_on": ["block_start"],
                    "name": "report",
                    "config": {
                        "new_buffer": true,
                        "maxsilence": 3,
                        "task_time": 30,
                        "minlength": 2,
                        "mode_buffer": 3
                    }
                },
                {
                    "action": "astersay.actions.SilenceAction",
                    "type": "silence",
                    "start_on": ["cq_first_say__finish"],
                    "name": "report_silence",
                    "config": {
                        "task_time": 20,
                        "max_silence": 18,
                        "new_buffer": true,
                        "phrases": ["Я вас не слышу."]
                    }
                }
            ],
            "exit_points": [
                {
                    "condition": ["report_result", "=", false],
                    "block": "bad_finish"
                },
                {
                    "condition": ["report_result", "=", true],
                    "block": "create_statement"
                }
            ]
        },
        "bad_finish": {
            "actions": [
                {
                    "start_on": ["block_start"],
                    "action": "astersay.actions.SayAction",
                    "config": {
                        "text": "Мне не удалось завиксировать ваш отзыв. Всего доброго, до свидания!"
                    },
                    "name": "bad_finish",
                    "type": "say"
                }
            ]
        },
        "create_statement": {
            "actions": [
                {
                    "action": "astersay.actions.SayAction",
                    "config": {
                        "text": "Ваш отзыв будет доведен до руководства онкологического диспансера. Ваше мнение очень важно для нас! Благодарим Вас за обратную связь, всего доброго, до свидания!"
                    },
                    "name": "question_say",
                    "start_on": ["block_start"],
                    "type": "say"
                },
                {
                    "action": "astersay.actions.AioHttpAction",
                    "config": {
                        "base_url": "{rest_api_url}",
                        "debug": true,
                        "headers": {
                            "Content-Type": "application/json",
                            "X-API-Key": "{rest_api_key}"
                        },
                        "json": {
                            "content": "Услуга - {category_say_value}, Оценка - {quality_str_value}, Комментарий - {report_value}",
                            "fullName": "-",
                            "phone": "{agi_callerid}",
                            "snils": "-",
                            "title": "ОБРАТНАЯ СВЯЗЬ",
                            "type": "0"
                        },
                        "method": "post",
                        "url": "/api/Aita/LeaveFeedback"
                    },
                    "name": "statement_post",
                    "start_on": ["block_start"],
                    "type": "aiohttp"
                }
            ]
        }
    },
    "dialog_class": "astersay.dialog.BaseDialog",
    "variables": {
        "rest_api_key": "",
        "rest_api_url": "https://dnevnik.itpolza.com"
    }
}
